name: Ruff Auto Fix

on:
  pull_request:  # í…ŒìŠ¤íŠ¸ìš© ì„ì‹œ ì¶”ê°€
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to run Ruff fix on'
        required: true
        type: string
      base_branch:
        description: 'Base branch for PR'
        required: false
        default: 'dev'
        type: string
      issue_number:
        description: 'Related issue number'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  security-events: write
  actions: read

jobs:
  ruff-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.head_ref }}
          fetch-depth: 0

      - name: Create Pull Request (workflow_dispatch only)
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ inputs.branch }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          gh pr create \
            --title "[FIX] Ruff auto-fix for #${ISSUE_NUMBER}" \
            --body "## Summary
          - Ruffë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œ ìŠ¤íƒ€ì¼ ìë™ ìˆ˜ì •

          ## Related Issue
          Closes #${ISSUE_NUMBER}

          ## Changes
          - \`ruff check --fix\` ì ìš©
          - \`ruff format\` ì ìš©

          ---
          ğŸ¤– Generated by GitHub Actions" \
            --base "${BASE_BRANCH}" \
            --head "${BRANCH}"

      - name: Setup Ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: "--version"

      - name: Run Ruff fix and format
        run: |
          ruff check --fix . || true
          ruff format .

      - name: Auto commit ruff fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style: auto-fix with ruff\n\nğŸ¤– Generated by GitHub Actions"
          file_pattern: "*.py"

      - name: Ruff check (SARIF)
        run: ruff check --output-format=sarif --output-file=ruff-results.sarif .
        continue-on-error: true
        id: ruff-sarif

      - name: Upload SARIF to GitHub
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: ruff-results.sarif
          category: ruff

      - name: Fail if ruff errors remain
        if: steps.ruff-sarif.outcome == 'failure'
        run: exit 1
