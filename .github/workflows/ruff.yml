name: Ruff Auto Fix

on:
  pull_request:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to run Ruff fix on'
        required: true
        type: string
      base_branch:
        description: 'Base branch for PR'
        required: false
        default: 'dev'
        type: string
      issue_number:
        description: 'Related issue number'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  ruff-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          ref: ${{ inputs.branch }}
          fetch-depth: 0

      - name: Setup Ruff
        uses: astral-sh/ruff-action@v3
        with:
          args: "--version"

      - name: Run Ruff fix and format
        run: |
          ruff check --fix . || true
          ruff format .

      - name: Auto commit ruff fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        id: auto-commit
        with:
          commit_message: "style: auto-fix with ruff\n\nğŸ¤– Generated by GitHub Actions"
          file_pattern: "*.py"

      - name: Ruff check
        run: ruff check --output-format=json --output-file=ruff-results.json . || true
        id: ruff-check

      - name: Create Check Run with Annotations (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: check-run
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync('ruff-results.json', 'utf8'));

            const annotations = results.slice(0, 50).map(r => ({
              path: r.filename.replace(process.cwd() + '/', ''),
              start_line: r.location.row,
              end_line: r.end_location.row,
              annotation_level: 'warning',
              message: `[${r.code}] ${r.message}`,
              title: r.code
            }));

            const sha = '${{ inputs.branch }}';
            const ref = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `heads/${sha}`
            });

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Ruff',
              head_sha: ref.data.object.sha,
              status: 'completed',
              conclusion: results.length > 0 ? 'failure' : 'success',
              output: {
                title: `Ruff found ${results.length} issue(s)`,
                summary: results.length > 0
                  ? `Found ${results.length} issue(s) that require manual fixes.`
                  : 'All checks passed!',
                annotations: annotations
              }
            });

            core.setOutput('has_errors', results.length > 0);

      - name: Ruff check (pull_request)
        if: github.event_name == 'pull_request'
        run: |
          ruff check --output-format=github .
        continue-on-error: true

      - name: Create Pull Request
        if: steps.auto-commit.outputs.changes_detected == 'true' || steps.check-run.outputs.has_errors == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          BRANCH: ${{ inputs.branch }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          ISSUE_NUMBER: ${{ inputs.issue_number }}
        run: |
          if gh pr view "${BRANCH}" &>/dev/null; then
            echo "PR already exists for ${BRANCH}, skipping creation"
          else
            gh pr create \
              --title "[FIX] Ruff auto-fix for #${ISSUE_NUMBER}" \
              --body "## Summary
            - Ruffë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œ ìŠ¤íƒ€ì¼ ìë™ ìˆ˜ì •

            ## Related Issue
            Closes #${ISSUE_NUMBER}

            ## Changes
            - \`ruff check --fix\` ì ìš©
            - \`ruff format\` ì ìš©

            ---
            ğŸ¤– Generated by GitHub Actions" \
              --base "${BASE_BRANCH}" \
              --head "${BRANCH}"
          fi

      - name: Fail if ruff errors remain
        if: (github.event_name == 'pull_request' && steps.ruff-check.outcome == 'failure') || steps.check-run.outputs.has_errors == 'true'
        run: exit 1
